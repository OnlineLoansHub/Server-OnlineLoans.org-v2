<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impressions Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .controls {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .form-row .form-group {
            flex-shrink: 0;
        }

        .form-row input,
        .form-row select {
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-row input:focus,
        .form-row select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .section {
            padding: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .section:last-child {
            border-bottom: none;
        }

        .brand-clicks-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            padding: 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .brand-clicks-grid:last-child {
            border-bottom: none;
        }

        #categorySelect {
            font-family: inherit;
        }

        #categorySelect:focus {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .export-btn {
            padding: 4px 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
            margin-left: auto;
            width: auto;
            flex-shrink: 0;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .table-wrapper {
            overflow-x: auto;
            overflow-y: visible;
            border: 1px solid #000;
            width: 100%;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            background: white;
        }

        .table-wrapper table {
            width: auto;
            min-width: fit-content;
        }

        .table-wrapper-compact {
            display: inline-block;
            width: auto;
            max-width: 100%;
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        table {
            width: auto;
            border-collapse: collapse;
            background: white;
            table-layout: auto;
        }

        thead {
            background: white;
            color: black;
        }

        th {
            padding: 8px 12px;
            text-align: left;
            font-weight: 700;
            font-size: 14px;
            white-space: nowrap;
            border-bottom: 1px solid #000;
            color: black;
        }

        tbody tr {
            border-bottom: 1px solid #000;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        td {
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 400;
            color: black;
            vertical-align: middle;
            text-align: left;
            white-space: nowrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-mobile {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-desktop {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-tablet {
            background: #fff3e0;
            color: #e65100;
        }

        .id-cell {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            position: relative;
            user-select: none;
            white-space: nowrap;
        }

        .id-cell:hover {
            color: #5568d3;
            text-decoration: underline;
        }

        .id-cell::after {
            content: ' üìã';
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 10px;
        }

        .id-cell:hover::after {
            opacity: 0.6;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
        }

        .sortable-header:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sort-arrow {
            position: absolute;
            right: 5px;
            font-size: 10px;
            opacity: 0.5;
        }

        .sort-arrow.active {
            opacity: 1;
        }

        .geo-info {
            font-size: 12px;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #c33;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .form-field {
            white-space: nowrap;
        }

        .answer-column {
            padding-right: 30px !important;
        }

        .form-field-empty {
            color: #adb5bd;
            font-style: italic;
        }

        .stats-section {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-card .label {
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .navbar-brand {
            color: white;
            font-size: 1.5em;
            font-weight: 700;
            text-decoration: none;
        }

        .navbar-nav {
            display: flex;
            gap: 20px;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .navbar-nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.3s;
        }

        .navbar-nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .navbar-nav a.active {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .navbar-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 15px 20px;
                flex-wrap: wrap;
            }

            .navbar-brand {
                font-size: 1.2em;
            }

            .navbar-toggle {
                display: block;
            }

            .navbar-nav {
                display: none;
                flex-direction: column;
                width: 100%;
                gap: 0;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
            }

            .navbar-nav.active {
                display: flex;
            }

            .navbar-nav li {
                width: 100%;
            }

            .navbar-nav a {
                display: block;
                padding: 12px 16px;
                width: 100%;
                border-radius: 0;
            }

            .navbar-nav a:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }
        }

        @media (max-width: 480px) {
            .navbar {
                padding: 12px 15px;
            }

            .navbar-brand {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <button class="navbar-toggle" onclick="toggleNavMenu()" aria-label="Toggle navigation menu">‚ò∞</button>
        <ul class="navbar-nav" id="navbarNav">
            <li><a href="/index.html" class="active">Impressions</a></li>
            <li><a href="/contact.html">Contact Us</a></li>
            <li><a href="/partner.html">Partner With Us</a></li>
        </ul>
    </nav>
    <div class="container">
        <div class="controls">
            <div class="form-row">
                <div class="form-group">
                    <label>API URL</label>
                    <input 
                        type="text" 
                        id="apiUrl" 
                        placeholder="API URL (e.g., https://server-ol-v2-fcaa9dab215e.herokuapp.com/api/impression)"
                        value="https://server-ol-v2-fcaa9dab215e.herokuapp.com/api/impression"
                    >
                </div>
                <div class="form-group">
                    <label>Filter by Date</label>
                    <input 
                        type="date" 
                        id="filterDate"
                    >
                </div>
                <div class="form-group">
                    <label>Date Filter Type</label>
                    <select id="dateFilterType">
                        <option value="exact">Exact Date</option>
                        <option value="after">After Date</option>
                        <option value="before">Before Date</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Geo</label>
                    <select id="geoFilter">
                        <option value="all">All Geos</option>
                        <option value="usa">USA</option>
                        <option value="usa-unknown">USA + Unknown</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Table</label>
                    <select id="mainTableSelect">
                        <option value="">-- Select a table --</option>
                        <option value="homepage-clicks">Home page LP Clicks</option>
                        <option value="businessLoans">Business Loans</option>
                        <option value="personalLoans">Personal Loans</option>
                        <option value="autoLoans">Auto Loans</option>
                        <option value="studentLoans">Student Loans</option>
                        <option value="mortgageLoans">Mortgage Loans</option>
                        <option value="cryptoLoans">Crypto Loans</option>
                        <option value="goldAndSilver">Gold and Silver</option>
                        <option value="petInsurance">Pet Insurance</option>
                        <option value="creditScore">Credit Score</option>
                        <option value="unknown">Unknown</option>
                        <option value="all-impressions">All Impressions</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button onclick="loadImpressions()">üîç Submit</button>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button onclick="resetFilters()">üîÑ Reset</button>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button onclick="cleanupImpressions()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">üóëÔ∏è Cleanup</button>
                </div>
            </div>
        </div>

        <div id="content">
            <div class="empty-state">
                <h2>Ready to search</h2>
                <p>Enter your API URL and click "Submit" to load impressions</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL_KEY = 'impressions_api_url';

        // Toggle mobile navigation menu
        function toggleNavMenu() {
            const navMenu = document.getElementById('navbarNav');
            navMenu.classList.toggle('active');
        }

        // Close mobile menu when clicking on a link
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.navbar-nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const navMenu = document.getElementById('navbarNav');
                    navMenu.classList.remove('active');
                });
            });
        });

        // Load saved API URL and set today's date
        window.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem(API_URL_KEY);
            if (savedUrl) {
                document.getElementById('apiUrl').value = savedUrl;
            }
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
        });

        // Save API URL when changed
        document.getElementById('apiUrl').addEventListener('change', (e) => {
            localStorage.setItem(API_URL_KEY, e.target.value);
        });

        function resetFilters() {
            // Reset date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
            
            // Reset date filter type to exact
            document.getElementById('dateFilterType').value = 'exact';
            
            // Reset geo filter to all
            document.getElementById('geoFilter').value = 'all';

            // Reset table selector
            document.getElementById('mainTableSelect').value = '';
            const tableContainer = document.getElementById('mainTableContainer');
            if (tableContainer) {
                tableContainer.innerHTML = '';
            }
        }

        async function loadImpressions() {
            const apiUrl = document.getElementById('apiUrl').value;
            const filterDate = document.getElementById('filterDate').value;
            const dateFilterType = document.getElementById('dateFilterType').value;
            const geoFilter = document.getElementById('geoFilter').value;
            const contentDiv = document.getElementById('content');

            if (!apiUrl) {
                showError('Please enter an API URL');
                return;
            }

            // Show loading state
            contentDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading impressions...</p>
                </div>
            `;

            try {
                // Build URL with query parameters
                let url = apiUrl;
                const params = new URLSearchParams();
                
                if (filterDate) {
                    if (dateFilterType === 'exact') {
                        params.append('createdAfter', filterDate);
                        params.append('createdBefore', filterDate + 'T23:59:59');
                    } else if (dateFilterType === 'after') {
                        params.append('createdAfter', filterDate);
                    } else if (dateFilterType === 'before') {
                        params.append('createdBefore', filterDate + 'T23:59:59');
                    }
                }

                // Add geo filter to query parameters (only for USA)
                if (geoFilter === 'usa') {
                    params.append('country', 'US');
                }


                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                let impressions = data.impressions || [];

                // Filter by exact date if needed
                if (filterDate && dateFilterType === 'exact') {
                    const filterDateObj = new Date(filterDate);
                    impressions = impressions.filter(imp => {
                        const impDate = new Date(imp.createdAt);
                        return impDate.toDateString() === filterDateObj.toDateString();
                    });
                }

                // Filter by geo location
                if (geoFilter === 'usa') {
                    impressions = impressions.filter(imp => {
                        const country = imp.geo?.country || imp.geo?.countryCode || '';
                        return country.toUpperCase() === 'US' || country.toUpperCase() === 'USA';
                    });
                } else if (geoFilter === 'usa-unknown') {
                    // "USA + Unknown" means USA or missing/unknown location
                    impressions = impressions.filter(imp => {
                        const country = imp.geo?.country || imp.geo?.countryCode || '';
                        const countryUpper = country.toUpperCase();
                        return countryUpper === 'US' || countryUpper === 'USA' || countryUpper === '' || !imp.geo;
                    });
                }
                // "All Geos" (geoFilter === 'all') shows all impressions - no filtering needed


                // Display tables
                if (impressions.length === 0) {
                    contentDiv.innerHTML = `
                        <div class="empty-state">
                            <h2>No impressions found</h2>
                            <p>Try adjusting your date filter or create some impressions</p>
                        </div>
                    `;
                } else {
                    contentDiv.innerHTML = createTables(impressions);
                    
                    // Show selected table if one was selected
                    const selectedTable = document.getElementById('mainTableSelect').value;
                    if (selectedTable) {
                        showSelectedTable(selectedTable);
                    }
                }
            } catch (error) {
                showError(`Error loading impressions: ${error.message}`);
            }
        }

        function createTables(impressions) {
            let html = '';

            // Stats section at the top
            html += `
                <div class="stats-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="number">${impressions.length}</div>
                            <div class="label">Total Impressions</div>
                        </div>
                    </div>
                </div>
            `;

            // Store impressions globally for dropdown functionality
            window.allImpressions = impressions;

            // Table container
            html += `
                <div id="mainTableContainer"></div>
            `;

            return html;
        }

        function showSelectedTable(tableType) {
            const container = document.getElementById('mainTableContainer');
            
            if (!container) {
                console.error('Table container not found');
                return;
            }
            
            if (!window.allImpressions) {
                container.innerHTML = `
                    <div class="section">
                        <div style="padding: 20px; text-align: center; color: #495057;">
                            Please click "Submit" first to load impressions data.
                        </div>
                    </div>
                `;
                return;
            }

            if (!tableType) {
                container.innerHTML = '';
                return;
            }

            const categoryLabels = {
                'businessLoans': 'Business Loans',
                'personalLoans': 'Personal Loans',
                'autoLoans': 'Auto Loans',
                'studentLoans': 'Student Loans',
                'mortgageLoans': 'Mortgage Loans',
                'cryptoLoans': 'Crypto Loans',
                'goldAndSilver': 'Gold and Silver',
                'petInsurance': 'Pet Insurance',
                'creditScore': 'Credit Score',
                'unknown': 'Unknown'
            };

            let html = '';

            if (tableType === 'homepage-clicks') {
                html += `
                    <div class="section">
                        <h2 class="section-title">
                            <span>Home page Lp clicks</span>
                            <button class="export-btn" onclick="exportToCSV('lpClicksTable', 'home-page-lp-clicks')">üì• Export to CSV</button>
                        </h2>
                        <div class="table-wrapper">
                            ${createLpClicksTable(window.allImpressions)}
                        </div>
                    </div>
                `;
            } else if (categoryLabels[tableType]) {
                // Brand clicks table for specific category
                const categoryLabel = categoryLabels[tableType];
                try {
                    html += `
                        <div class="section">
                            <h2 class="section-title">
                                <span>${categoryLabel} - Brand Clicks</span>
                                <button class="export-btn" onclick="exportToCSV('${tableType}BrandClicksTable', '${tableType}-brand-clicks')">üì• Export</button>
                            </h2>
                            <div class="table-wrapper table-wrapper-compact">
                                ${createCategoryBrandClicksTable(window.allImpressions, tableType, categoryLabel)}
                            </div>
                        </div>
                        <div class="section" style="margin-top: 30px;">
                            <h2 class="section-title">
                                <span>${categoryLabel} - Impressions Data</span>
                                <button class="export-btn" onclick="exportToCSV('${tableType}ImpressionsTable', '${tableType}-impressions')">üì• Export to CSV</button>
                            </h2>
                            <div class="table-wrapper">
                                ${createCategoryImpressionsTable(window.allImpressions, tableType, categoryLabel)}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error creating category table:', error);
                    html += `
                        <div class="section">
                            <div style="padding: 20px; text-align: center; color: #dc3545;">
                                Error loading table: ${error.message}
                            </div>
                        </div>
                    `;
                }
            } else if (tableType === 'all-impressions') {
                html += `
                    <div class="section">
                        <h2 class="section-title">
                            <span>All Impressions</span>
                            <button class="export-btn" onclick="exportToCSV('allImpressionsTable', 'all-impressions')">üì• Export to CSV</button>
                        </h2>
                        <div class="table-wrapper">
                            ${createAllImpressionsTable(window.allImpressions)}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function createLpClicksTable(impressions) {
            const categories = [
                'Business Loans',
                'Mortgage Loans',
                'Student Loans',
                'Personal Loans',
                'Auto Loans',
                'Pet Insurance',
                'Credit Score',
                'Crypto Loans',
                'Gold and Silver'
            ];

            // Count lpClicks for each category
            const categoryCounts = {};
            categories.forEach(category => {
                categoryCounts[category] = 0;
            });

            impressions.forEach(impression => {
                const homepageClicks = impression.homepageClicks || {};
                categories.forEach(category => {
                    if (homepageClicks[category] === true) {
                        categoryCounts[category]++;
                    }
                });
            });

            const totalImpressions = impressions.length;

            // Build category data array
            const categoryData = categories.map(category => {
                const count = categoryCounts[category];
                const percentage = totalImpressions > 0 
                    ? ((count / totalImpressions) * 100).toFixed(2) 
                    : '0.00';
                return { category, count, percentage: parseFloat(percentage) };
            });

            let html = `
                <table id="lpClicksTable" style="font-size: 14px;">
                    <thead>
                        <tr>
                            <th class="sortable-header" style="padding: 8px 12px;" onclick="sortLpClicksTable('category')">
                                Category
                                <span class="sort-arrow" id="sort-category">‚áÖ</span>
                            </th>
                            <th class="sortable-header" style="padding: 8px 12px; text-align: center;" onclick="sortLpClicksTable('clicks')">
                                LP Clicks
                                <span class="sort-arrow" id="sort-clicks">‚áÖ</span>
                            </th>
                            <th class="sortable-header" style="padding: 8px 12px; text-align: center;" onclick="sortLpClicksTable('percentage')">
                                Percentage
                                <span class="sort-arrow" id="sort-percentage">‚áÖ</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="lpClicksTableBody">
                        <tr>
                            <td style="padding: 6px 12px;"><strong>Total Impressions</strong></td>
                            <td style="padding: 6px 12px; text-align: center;"><strong>${totalImpressions}</strong></td>
                            <td style="padding: 6px 12px; text-align: center;"><strong>100.00%</strong></td>
                        </tr>
            `;

            categoryData.forEach(item => {
                html += `
                    <tr>
                        <td style="padding: 6px 12px;">${item.category}</td>
                        <td style="padding: 6px 12px; text-align: center;">${item.count}</td>
                        <td style="padding: 6px 12px; text-align: center;">${item.percentage.toFixed(2)}%</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            // Store category data globally for sorting
            window.lpClicksCategoryData = categoryData;
            window.lpClicksTotalImpressions = totalImpressions;
            window.lpClicksCurrentSort = { column: null, direction: 'asc' };

            return html;
        }

        function sortLpClicksTable(column) {
            const tbody = document.getElementById('lpClicksTableBody');
            if (!tbody || !window.lpClicksCategoryData) return;

            const data = window.lpClicksCategoryData;
            const currentSort = window.lpClicksCurrentSort;

            // Determine sort direction
            let direction = 'asc';
            if (currentSort.column === column && currentSort.direction === 'asc') {
                direction = 'desc';
            }

            // Sort the data
            const sortedData = [...data].sort((a, b) => {
                let comparison = 0;
                if (column === 'category') {
                    comparison = a.category.localeCompare(b.category);
                } else if (column === 'clicks') {
                    comparison = a.count - b.count;
                } else if (column === 'percentage') {
                    comparison = a.percentage - b.percentage;
                }

                return direction === 'asc' ? comparison : -comparison;
            });

            // Update sort state
            window.lpClicksCurrentSort = { column, direction };

            // Update sort arrows
            document.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.textContent = '‚áÖ';
                arrow.classList.remove('active');
            });

            const arrowId = `sort-${column}`;
            const arrow = document.getElementById(arrowId);
            if (arrow) {
                arrow.textContent = direction === 'asc' ? '‚Üë' : '‚Üì';
                arrow.classList.add('active');
            }

            // Rebuild table rows (excluding Total Impressions row)
            let html = `
                <tr>
                    <td style="padding: 6px 12px;"><strong>Total Impressions</strong></td>
                    <td style="padding: 6px 12px; text-align: center;"><strong>${window.lpClicksTotalImpressions}</strong></td>
                    <td style="padding: 6px 12px; text-align: center;"><strong>100.00%</strong></td>
                </tr>
            `;

            sortedData.forEach(item => {
                html += `
                    <tr>
                        <td style="padding: 6px 12px;">${item.category}</td>
                        <td style="padding: 6px 12px; text-align: center;">${item.count}</td>
                        <td style="padding: 6px 12px; text-align: center;">${item.percentage.toFixed(2)}%</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function createCategoryBrandClicksTable(impressions, pageKey, pageLabel) {
            // Count total users who visited this page (have this pageKey field)
            let totalUsers = 0;
            
            // Count brand clicks for this specific page category
            const brandCounts = {};

            impressions.forEach(impression => {
                const pageData = impression[pageKey];
                
                // Count users who visited this page (have the pageKey field)
                if (pageData !== undefined && pageData !== null) {
                    totalUsers++;
                    
                    // Count brand clicks if pageData is an object with brand clicks
                    if (typeof pageData === 'object') {
                        // Iterate through brands in this page
                        Object.keys(pageData).forEach(brandName => {
                            // Only count if the value is true (actual click)
                            if (pageData[brandName] === true) {
                                if (!brandCounts[brandName]) {
                                    brandCounts[brandName] = 0;
                                }
                                brandCounts[brandName]++;
                            }
                        });
                    }
                }
            });

            // Convert to array and sort by count (descending)
            const brandData = Object.keys(brandCounts).map(brandName => ({
                brand: brandName,
                count: brandCounts[brandName]
            })).sort((a, b) => b.count - a.count);

            const totalBrandClicks = brandData.reduce((sum, item) => sum + item.count, 0);

            // Create unique IDs for this category
            const tableId = `${pageKey}BrandClicksTable`;
            const tbodyId = `${pageKey}BrandClicksTableBody`;
            const sortPrefix = pageKey.replace(/([A-Z])/g, '-$1').toLowerCase();

            let html = `
                <table id="${tableId}" style="font-size: 14px;">
                    <thead>
                        <tr>
                            <th class="sortable-header" style="padding: 8px 12px;" onclick="sortCategoryBrandClicksTable('${pageKey}', 'brand')">
                                Brand Name
                                <span class="sort-arrow" id="sort-${sortPrefix}-brand-name">‚áÖ</span>
                            </th>
                            <th class="sortable-header" style="padding: 8px 12px; text-align: center;" onclick="sortCategoryBrandClicksTable('${pageKey}', 'clicks')">
                                Total Clicks
                                <span class="sort-arrow" id="sort-${sortPrefix}-brand-clicks">‚áÖ</span>
                            </th>
                            <th class="sortable-header" style="padding: 8px 12px; text-align: center;" onclick="sortCategoryBrandClicksTable('${pageKey}', 'percentage')">
                                Percentage
                                <span class="sort-arrow" id="sort-${sortPrefix}-brand-percentage">‚áÖ</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="${tbodyId}">
                        <tr>
                            <td style="font-weight: 700; padding: 6px 12px;">Total Users</td>
                            <td style="text-align: center; font-weight: 700; padding: 6px 12px;">${totalUsers}</td>
                            <td style="text-align: center; font-weight: 700; padding: 6px 12px;">‚Äî</td>
                        </tr>
            `;

            if (brandData.length === 0) {
                html += `
                    <tr>
                        <td colspan="3" style="padding: 12px; text-align: center;">
                            No brand clicks recorded for ${pageLabel}
                        </td>
                    </tr>
                `;
            } else {
                brandData.forEach(item => {
                    // Percentage based on total users (how many users clicked this brand)
                    const percentage = totalUsers > 0 
                        ? ((item.count / totalUsers) * 100).toFixed(2) 
                        : '0.00';
                    html += `
                        <tr>
                            <td style="padding: 6px 12px;">${item.brand}</td>
                            <td style="text-align: center; padding: 6px 12px;">${item.count}</td>
                            <td style="text-align: center; padding: 6px 12px;">${percentage}%</td>
                        </tr>
                    `;
                });
            }
            
            html += `
                        <tr>
                            <td style="font-weight: 700; padding: 6px 12px;">Total Brand Clicks</td>
                            <td style="text-align: center; font-weight: 700; padding: 6px 12px;">${totalBrandClicks}</td>
                            <td style="text-align: center; font-weight: 700; padding: 6px 12px;">${totalUsers > 0 ? ((totalBrandClicks / totalUsers) * 100).toFixed(2) : '0.00'}%</td>
                        </tr>
            `;

            html += `
                    </tbody>
                </table>
            `;

            // Store brand data globally for sorting (using pageKey as key)
            if (!window.categoryBrandClicksData) {
                window.categoryBrandClicksData = {};
            }
            if (!window.categoryBrandClicksSort) {
                window.categoryBrandClicksSort = {};
            }

            window.categoryBrandClicksData[pageKey] = brandData;
            window.categoryBrandClicksTotal = window.categoryBrandClicksTotal || {};
            window.categoryBrandClicksTotal[pageKey] = totalBrandClicks;
            window.categoryBrandClicksUsers = window.categoryBrandClicksUsers || {};
            window.categoryBrandClicksUsers[pageKey] = totalUsers;
            window.categoryBrandClicksSort[pageKey] = { column: null, direction: 'asc' };

            return html;
        }

        function sortCategoryBrandClicksTable(pageKey, column) {
            const tbodyId = `${pageKey}BrandClicksTableBody`;
            const tbody = document.getElementById(tbodyId);
            if (!tbody || !window.categoryBrandClicksData || !window.categoryBrandClicksData[pageKey]) return;

            const data = window.categoryBrandClicksData[pageKey];
            const currentSort = window.categoryBrandClicksSort[pageKey] || { column: null, direction: 'asc' };

            // Determine sort direction
            let direction = 'asc';
            if (currentSort.column === column && currentSort.direction === 'asc') {
                direction = 'desc';
            }

            // Sort the data
            const sortedData = [...data].sort((a, b) => {
                let comparison = 0;
                if (column === 'brand') {
                    comparison = a.brand.localeCompare(b.brand);
                } else if (column === 'clicks') {
                    comparison = a.count - b.count;
                } else if (column === 'percentage') {
                    const total = window.categoryBrandClicksTotal[pageKey] || 0;
                    const aPct = total > 0 ? (a.count / total) * 100 : 0;
                    const bPct = total > 0 ? (b.count / total) * 100 : 0;
                    comparison = aPct - bPct;
                }

                return direction === 'asc' ? comparison : -comparison;
            });

            // Update sort state
            window.categoryBrandClicksSort[pageKey] = { column, direction };

            // Update sort arrows for this specific table
            const sortPrefix = pageKey.replace(/([A-Z])/g, '-$1').toLowerCase();
            const tableId = `${pageKey}BrandClicksTable`;
            document.querySelectorAll(`#${tableId} .sort-arrow`).forEach(arrow => {
                arrow.textContent = '‚áÖ';
                arrow.classList.remove('active');
            });

            const arrowId = column === 'brand' ? `sort-${sortPrefix}-brand-name` : 
                          column === 'clicks' ? `sort-${sortPrefix}-brand-clicks` : 
                          `sort-${sortPrefix}-brand-percentage`;
            const arrow = document.getElementById(arrowId);
            if (arrow) {
                arrow.textContent = direction === 'asc' ? '‚Üë' : '‚Üì';
                arrow.classList.add('active');
            }

            // Rebuild table rows (including Total Users and Total Brand Clicks rows)
            const totalClicks = window.categoryBrandClicksTotal[pageKey] || 0;
            const totalUsers = window.categoryBrandClicksUsers[pageKey] || 0;
            
            let html = `
                <tr>
                    <td style="font-weight: 700; padding: 6px 12px;">Total Users</td>
                    <td style="text-align: center; font-weight: 700; padding: 6px 12px;">${totalUsers}</td>
                    <td style="text-align: center; font-weight: 700; padding: 6px 12px;">‚Äî</td>
                </tr>
            `;

            if (sortedData.length === 0) {
                html += `
                    <tr>
                        <td colspan="3" style="padding: 12px; text-align: center;">
                            No brand clicks recorded
                        </td>
                    </tr>
                `;
            } else {
                sortedData.forEach(item => {
                    // Percentage based on total users (how many users clicked this brand)
                    const percentage = totalUsers > 0 
                        ? ((item.count / totalUsers) * 100).toFixed(2) 
                        : '0.00';
                    html += `
                        <tr>
                            <td style="padding: 6px 12px;">${item.brand}</td>
                            <td style="text-align: center; padding: 6px 12px;">${item.count}</td>
                            <td style="text-align: center; padding: 6px 12px;">${percentage}%</td>
                        </tr>
                    `;
                });
            }
            
            html += `
                <tr>
                    <td style="font-weight: 700; padding: 6px 12px;">Total Brand Clicks</td>
                    <td style="text-align: center; font-weight: 700; padding: 6px 12px;">${totalClicks}</td>
                    <td style="text-align: center; font-weight: 700; padding: 6px 12px;">${totalUsers > 0 ? ((totalClicks / totalUsers) * 100).toFixed(2) : '0.00'}%</td>
                </tr>
            `;

            tbody.innerHTML = html;
        }

        function createAllImpressionsTable(impressions) {
            if (impressions.length === 0) {
                return '<div class="empty-state"><p>No impressions found</p></div>';
            }

            let html = `
                <table id="allImpressionsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date ${getGMTOffset()}</th>
                            <th>IP Address</th>
                            <th>Device</th>
                            <th>UA Bot</th>
                            <th>OP</th>
                            <th>Browser</th>
                            <th>Location</th>
                            <th>Referrer</th>
                            <th>Sub1</th>
                            <th>Sub2</th>
                            <th>Sub3</th>
                            <th>Sub4</th>
                            <th>Sub5</th>
                            <th>Sub6</th>
                            <th>Sub7</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            impressions.forEach(impression => {
                const id = impression._id || impression.id;
                const date = formatDate(impression.createdAt);
                const deviceBadge = getDeviceBadge(impression.deviceType);
                const userAgent = impression.userAgent || '';
                const isBot = userAgent.toLowerCase().includes('bot') ? '‚úì' : '‚úó';
                const os = extractOS(userAgent);
                const browser = extractBrowser(userAgent);
                const location = formatLocation(impression.geo);
                const referrer = impression.referrer ? 
                    (impression.referrer.length > 60 ? impression.referrer.substring(0, 60) + '...' : impression.referrer) 
                    : '‚Äî';

                html += `
                    <tr>
                        <td class="id-cell" onclick="copyToClipboard('${id}')" title="Click to copy ID">${id}</td>
                        <td>${date}</td>
                        <td>${impression.userIp || 'N/A'}</td>
                        <td>${deviceBadge}</td>
                        <td>${isBot}</td>
                        <td>${os}</td>
                        <td>${browser}</td>
                        <td class="geo-info">${location}</td>
                        <td title="${impression.referrer || ''}">${referrer}</td>
                        <td>${impression.sub1 || '‚Äî'}</td>
                        <td>${impression.sub2 || '‚Äî'}</td>
                        <td>${impression.sub3 || '‚Äî'}</td>
                        <td>${impression.sub4 || '‚Äî'}</td>
                        <td>${impression.sub5 || '‚Äî'}</td>
                        <td>${impression.sub6 || '‚Äî'}</td>
                        <td>${impression.sub7 || '‚Äî'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            return html;
        }

        function createCategoryImpressionsTable(impressions, pageKey, pageLabel) {
            // Filter impressions that have clicked on brands in this category
            const filteredImpressions = impressions.filter(impression => {
                const pageData = impression[pageKey];
                if (pageData !== undefined && pageData !== null && typeof pageData === 'object') {
                    // Check if there's at least one brand click (value === true)
                    return Object.values(pageData).some(value => value === true);
                }
                return false;
            });

            if (filteredImpressions.length === 0) {
                return '<div class="empty-state"><p>No impressions found with brand clicks for ' + pageLabel + '</p></div>';
            }

            const tableId = `${pageKey}ImpressionsTable`;

            let html = `
                <table id="${tableId}">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date ${getGMTOffset()}</th>
                            <th>IP Address</th>
                            <th>Device</th>
                            <th>UA Bot</th>
                            <th>OP</th>
                            <th>Browser</th>
                            <th>Location</th>
                            <th>Referrer</th>
                            <th>Sub1</th>
                            <th>Sub2</th>
                            <th>Sub3</th>
                            <th>Sub4</th>
                            <th>Sub5</th>
                            <th>Sub6</th>
                            <th>Sub7</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredImpressions.forEach(impression => {
                const id = impression._id || impression.id;
                const date = formatDate(impression.createdAt);
                const deviceBadge = getDeviceBadge(impression.deviceType);
                const userAgent = impression.userAgent || '';
                const isBot = userAgent.toLowerCase().includes('bot') ? '‚úì' : '‚úó';
                const os = extractOS(userAgent);
                const browser = extractBrowser(userAgent);
                const location = formatLocation(impression.geo);
                const referrer = impression.referrer ? 
                    (impression.referrer.length > 60 ? impression.referrer.substring(0, 60) + '...' : impression.referrer) 
                    : '‚Äî';

                html += `
                    <tr>
                        <td class="id-cell" onclick="copyToClipboard('${id}')" title="Click to copy ID">${id}</td>
                        <td>${date}</td>
                        <td>${impression.userIp || 'N/A'}</td>
                        <td>${deviceBadge}</td>
                        <td>${isBot}</td>
                        <td>${os}</td>
                        <td>${browser}</td>
                        <td class="geo-info">${location}</td>
                        <td title="${impression.referrer || ''}">${referrer}</td>
                        <td>${impression.sub1 || '‚Äî'}</td>
                        <td>${impression.sub2 || '‚Äî'}</td>
                        <td>${impression.sub3 || '‚Äî'}</td>
                        <td>${impression.sub4 || '‚Äî'}</td>
                        <td>${impression.sub5 || '‚Äî'}</td>
                        <td>${impression.sub6 || '‚Äî'}</td>
                        <td>${impression.sub7 || '‚Äî'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            return html;
        }


        function getDeviceBadge(deviceType) {
            const badges = {
                mobile: '<span class="badge badge-mobile">üì± Mobile</span>',
                desktop: '<span class="badge badge-desktop">üñ•Ô∏è Desktop</span>',
                tablet: '<span class="badge badge-tablet">üì± Tablet</span>'
            };
            return badges[deviceType] || deviceType;
        }

        function formatLocation(geo) {
            if (!geo) return 'N/A';
            const parts = [];
            if (geo.city) parts.push(geo.city);
            if (geo.region) parts.push(geo.region);
            if (geo.country) parts.push(geo.country);
            return parts.length > 0 ? parts.join(', ') : 'N/A';
        }

        function extractOS(userAgent) {
            if (!userAgent) return 'N/A';
            const ua = userAgent.toLowerCase();
            
            if (ua.includes('windows nt 10.0')) return 'Windows 10';
            if (ua.includes('windows nt 6.3')) return 'Windows 8.1';
            if (ua.includes('windows nt 6.2')) return 'Windows 8';
            if (ua.includes('windows nt 6.1')) return 'Windows 7';
            if (ua.includes('windows nt 6.0')) return 'Windows Vista';
            if (ua.includes('windows nt 5.1') || ua.includes('windows nt 5.2')) return 'Windows XP';
            if (ua.includes('windows')) return 'Windows';
            if (ua.includes('mac os x') || ua.includes('macintosh')) return 'macOS';
            if (ua.includes('iphone os') || ua.includes('iphone')) return 'iOS';
            if (ua.includes('android')) return 'Android';
            if (ua.includes('linux')) return 'Linux';
            if (ua.includes('ubuntu')) return 'Ubuntu';
            if (ua.includes('fedora')) return 'Fedora';
            if (ua.includes('chrome os')) return 'Chrome OS';
            
            return 'Unknown';
        }

        function extractBrowser(userAgent) {
            if (!userAgent) return 'N/A';
            const ua = userAgent.toLowerCase();
            
            if (ua.includes('edg/')) return 'Edge';
            if (ua.includes('edgios/')) return 'Edge iOS';
            if (ua.includes('edga/')) return 'Edge Android';
            if (ua.includes('chrome/') && !ua.includes('edg')) return 'Chrome';
            if (ua.includes('safari/') && !ua.includes('chrome') && !ua.includes('edg')) return 'Safari';
            if (ua.includes('firefox/')) return 'Firefox';
            if (ua.includes('opera/') || ua.includes('opr/')) return 'Opera';
            if (ua.includes('msie') || ua.includes('trident/')) return 'IE';
            if (ua.includes('samsungbrowser/')) return 'Samsung Internet';
            if (ua.includes('ucbrowser/')) return 'UC Browser';
            if (ua.includes('yabrowser/')) return 'Yandex Browser';
            if (ua.includes('brave/')) return 'Brave';
            
            return 'Unknown';
        }

        function getGMTOffset() {
            const date = new Date();
            const offset = -date.getTimezoneOffset() / 60;
            return offset >= 0 ? `+${offset}` : `${offset}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            
            // Format: MM/DD/YY HH:MM (no seconds, 2-digit year)
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${month}/${day}/${year} ${hours}:${minutes}`;
        }

        function exportToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) {
                showError('Table not found');
                return;
            }

            let csv = [];
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('th, td');
                
                cells.forEach(cell => {
                    // Get text content, removing any HTML tags and special characters
                    let text = cell.innerText || cell.textContent || '';
                    // Replace newlines and commas
                    text = text.replace(/\n/g, ' ').replace(/,/g, ';');
                    // Wrap in quotes if contains special characters
                    if (text.includes('"') || text.includes('\n') || text.includes(',')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    rowData.push(text);
                });
                
                csv.push(rowData.join(','));
            });

            // Create CSV content
            const csvContent = csv.join('\n');
            
            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showError(message) {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="error">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show temporary feedback
                const event = new CustomEvent('idCopied', { detail: text });
                document.dispatchEvent(event);
                
                // Visual feedback - you could add a toast notification here
                console.log('Copied to clipboard:', text);
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    console.log('Copied to clipboard (fallback):', text);
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }
                document.body.removeChild(textArea);
            });
        }

        async function cleanupImpressions() {
            const apiUrl = document.getElementById('apiUrl').value;
            const contentDiv = document.getElementById('content');

            if (!apiUrl) {
                showError('Please enter an API URL');
                return;
            }

            // Confirm deletion
            const confirmed = confirm(
                'This will delete all impressions where:\n' +
                '‚Ä¢ geo.city = "Shoresh"\n' +
                '‚Ä¢ referrer contains "localhost"\n' +
                '‚Ä¢ referrer contains "10.0.0.7"\n\n' +
                'Are you sure you want to proceed?'
            );

            if (!confirmed) {
                return;
            }

            // Show loading state
            contentDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Cleaning up impressions...</p>
                </div>
            `;

            try {
                // Build cleanup URL
                const baseUrl = apiUrl.replace('/api/impression', '');
                const cleanupUrl = `${baseUrl}/api/impression/cleanup`;

                const response = await fetch(cleanupUrl, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Show success message
                contentDiv.innerHTML = `
                    <div class="stats-section">
                        <div class="stats-grid">
                            <div class="stat-card" style="background: #d4edda; border: 2px solid #28a745;">
                                <div class="number" style="color: #155724;">${data.deletedCount}</div>
                                <div class="label" style="color: #155724;">Deleted Impressions</div>
                            </div>
                            <div class="stat-card">
                                <div class="number">${data.totalRemaining}</div>
                                <div class="label">Remaining Impressions</div>
                            </div>
                        </div>
                    </div>
                    <div class="section">
                        <div style="padding: 20px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                            <h3 style="color: #155724; margin-bottom: 10px;">‚úÖ Cleanup Complete</h3>
                            <p style="color: #155724; margin-bottom: 5px;"><strong>${data.message}</strong></p>
                            <p style="color: #155724; font-size: 14px; margin-top: 10px;">
                                Click "Submit" to reload impressions and see the updated list.
                            </p>
                        </div>
                    </div>
                `;
            } catch (error) {
                showError(`Error during cleanup: ${error.message}`);
            }
        }

        function showBrandClicksTable(categoryKey) {
            const container = document.getElementById('brandClicksTableContainer');
            if (!container || !window.allImpressions) return;

            if (!categoryKey) {
                container.innerHTML = '';
                return;
            }

            const categories = {
                'businessLoans': 'Business Loans',
                'personalLoans': 'Personal Loans',
                'autoLoans': 'Auto Loans',
                'studentLoans': 'Student Loans',
                'mortgageLoans': 'Mortgage Loans',
                'cryptoLoans': 'Crypto Loans',
                'goldAndSilver': 'Gold and Silver',
                'petInsurance': 'Pet Insurance',
                'creditScore': 'Credit Score',
                'unknown': 'Unknown'
            };

            const categoryLabel = categories[categoryKey] || categoryKey;

            container.innerHTML = `
                <div class="brand-click-section">
                    <h2 class="section-title" style="font-size: 1.4em; margin-bottom: 15px;">
                        <span>${categoryLabel}</span>
                        <button class="export-btn" onclick="exportToCSV('${categoryKey}BrandClicksTable', '${categoryKey}-brand-clicks')">üì• Export</button>
                    </h2>
                    <div class="table-wrapper">
                        ${createCategoryBrandClicksTable(window.allImpressions, categoryKey, categoryLabel)}
                    </div>
                </div>
            `;
        }

        // Allow Enter key to submit
        document.getElementById('apiUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadImpressions();
        });
        document.getElementById('filterDate').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadImpressions();
        });
    </script>
</body>
</html>
